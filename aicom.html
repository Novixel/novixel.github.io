<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novi - AI Companion Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Dark Theme Color Palette */
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-darker: #0a0f1e;
            --border-color: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            
            /* Accent Colors */
            --accent-primary: #10b981;
            --accent-hover: #059669;
            --accent-light: #34d399;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
        }
        
        /* Custom Scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-card);
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Custom animation for typing indicator */
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        .dot-bounce div {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot-bounce .dot-1 {
            animation-delay: -0.32s;
        }
        .dot-bounce .dot-2 {
            animation-delay: -0.16s;
        }
        
        /* Password Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        
        .password-input {
            width: 100%;
            padding: 10px 14px;
            background-color: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .password-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .modal-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .modal-button-primary {
            background-color: var(--accent-primary);
            color: white;
            border: none;
        }
        
        .modal-button-primary:hover {
            background-color: var(--accent-hover);
        }
        
        .modal-button-secondary {
            background-color: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        .modal-button-secondary:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Password Modal -->
    <div id="passwordModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-2" style="color: var(--text-primary);">üîë Welcome to Novi!</h2>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">Enter your Google Gemini API key or demo master password:</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Key / Password:</label>
                <input type="password" id="passwordInput" class="password-input" placeholder="Enter key or password..." autocomplete="off">
                <button onclick="togglePasswordVisibility()" class="text-xs mt-2" style="color: var(--text-muted);">
                    <span id="toggleIcon">üëÅÔ∏è Show</span>
                </button>
            </div>
            
            <p class="text-xs mb-4" style="color: var(--text-muted);">
                Don't have an API key? Get one free at:<br>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--accent-primary);" class="hover:underline">aistudio.google.com/app/apikey</a>
            </p>
            
            <div class="flex gap-2">
                <button onclick="submitPassword()" class="modal-button modal-button-primary flex-1">
                    Continue
                </button>
                <button onclick="closeModal()" class="modal-button modal-button-secondary">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="flex flex-col h-screen w-full max-w-lg mx-auto shadow-2xl" style="background-color: var(--bg-card);">

        <!-- Header -->
        <header class="text-white p-4 flex items-center justify-between shadow-lg z-10" style="background-color: var(--bg-darker); border-bottom: 1px solid var(--border-color);">
            <div class="flex items-center">
                <div class="relative w-10 h-10 mr-4">
                     <div class="w-10 h-10 rounded-full" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));"></div>
                     <div id="status-indicator" class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2" style="background-color: var(--accent-light); border-color: var(--bg-darker);"></div>
                </div>
                <div>
                    <h1 class="text-lg font-semibold" style="color: var(--text-primary);">Novi ‚ú®</h1>
                    <p class="text-sm" style="color: var(--text-secondary);">Your Playful AI Buddy üéâ</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="changeApiKey()" class="transition-colors text-sm px-3 py-1 rounded border hover:bg-opacity-10 hover:bg-white" style="color: var(--text-secondary); border-color: var(--border-color);" title="Change API Key">
                    üîë Key
                </button>
                <button onclick="clearChatHistory()" class="transition-colors text-sm px-3 py-1 rounded border hover:bg-opacity-10 hover:bg-white" style="color: var(--text-secondary); border-color: var(--border-color);" title="Start a new chat">
                    üóëÔ∏è Clear
                </button>
            </div>
        </header>

        <!-- Chat Messages -->
        <main id="chat-messages" class="flex-1 p-4 overflow-y-auto chat-messages" style="background-color: var(--bg-main);">
             <!-- Messages will be loaded here by JavaScript -->
             <!-- Typing indicator will be injected here -->
        </main>

        <!-- Message Input -->
        <footer class="border-t p-4" style="background-color: var(--bg-card); border-color: var(--border-color);">
            <form id="chat-form" class="flex items-center gap-3">
                <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 transition-shadow" style="background-color: var(--bg-darker); border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--accent-primary);">
                <button type="submit" id="send-button" class="text-white rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0 transition-transform transform active:scale-95" style="background-color: var(--accent-primary);" onmouseover="this.style.backgroundColor='var(--accent-hover)'" onmouseout="this.style.backgroundColor='var(--accent-primary)'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                </button>
            </form>
            
            <!-- Navigation Links -->
            <div class="mt-3 pt-3 border-t text-center" style="border-color: var(--border-color);">
                <p class="text-xs" style="color: var(--text-muted);">
                    <a href="index.html" class="font-semibold hover:underline" style="color: var(--accent-primary);">Home</a> ‚Ä¢
                    <a href="Novixel.html" class="font-semibold hover:underline" style="color: var(--accent-primary);">Portfolio</a> ‚Ä¢
                    <a href="tradingbots.html" class="font-semibold hover:underline" style="color: var(--accent-primary);">Trading</a> ‚Ä¢
                    <a href="novatrade.html" class="font-semibold hover:underline" style="color: #D4AF37;">NovaTrade</a> ‚Ä¢
                    <a href="novalite.html" class="font-semibold hover:underline" style="color: #7FFF00;">NovaLite</a> ‚Ä¢
                    <a href="coffee.html" class="font-semibold hover:underline" style="color: #8B4513;">Coffee Solutions</a>
                </p>
                <p class="text-xs mt-1" style="color: var(--text-muted);">&copy; 2025 Novixel. All rights reserved.</p>
            </div>
        </footer>

    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const sendButton = document.getElementById('send-button');

        // ENCRYPTED DEMO KEY - Replace this with your encrypted key
        // To generate: Use the console command: encryptKey("YOUR_API_KEY", "YOUR_MASTER_PASSWORD")
        const ENCRYPTED_DEMO_KEY = "ETkWEiYSKXwDFj5ePgQIHQVHYzYqJBsFPUp5BDciFy8jW21jBTtU";
        
        function xorEncryptDecrypt(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return result;
        }
        
        function encryptKey(apiKey, masterPassword) {
            const encrypted = xorEncryptDecrypt(apiKey, masterPassword);
            return btoa(encrypted); // Base64 encode
        }
        
        function decryptKey(encryptedKey, masterPassword) {
            try {
                const decoded = atob(encryptedKey); // Base64 decode
                return xorEncryptDecrypt(decoded, masterPassword);
            } catch (e) {
                return null;
            }
        }
        
        // Helper function to set up your encrypted key (run in console)
        window.setupDemoKey = function(apiKey, masterPassword) {
            const encrypted = encryptKey(apiKey, masterPassword);
            console.log("Add this to your code as ENCRYPTED_DEMO_KEY:");
            console.log(`const ENCRYPTED_DEMO_KEY = "${encrypted}";`);
            return encrypted;
        };

        // Modal functions
        let resolvePasswordPromise;
        
        function showPasswordModal() {
            return new Promise((resolve) => {
                resolvePasswordPromise = resolve;
                document.getElementById('passwordModal').style.display = 'flex';
                document.getElementById('passwordInput').focus();
                
                // Allow Enter key to submit
                document.getElementById('passwordInput').onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        submitPassword();
                    }
                };
            });
        }
        
        function closeModal() {
            document.getElementById('passwordModal').style.display = 'none';
            if (resolvePasswordPromise) {
                resolvePasswordPromise(null);
            }
        }
        
        function submitPassword() {
            const value = document.getElementById('passwordInput').value.trim();
            document.getElementById('passwordModal').style.display = 'none';
            if (resolvePasswordPromise) {
                resolvePasswordPromise(value);
            }
        }
        
        function togglePasswordVisibility() {
            const input = document.getElementById('passwordInput');
            const icon = document.getElementById('toggleIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'üôà Hide';
            } else {
                input.type = 'password';
                icon.textContent = 'üëÅÔ∏è Show';
            }
        }

        // Get API key from localStorage or show modal
        let apiKey = localStorage.getItem('gemini-api-key');
        
        async function initializeApiKey() {
            if (!apiKey) {
                const userInput = await showPasswordModal();
                
                if (userInput) {
                    const trimmedInput = userInput;
                    
                    // Check if it's the master password (try to decrypt)
                    if (ENCRYPTED_DEMO_KEY) {
                        const decryptedKey = decryptKey(ENCRYPTED_DEMO_KEY, trimmedInput);
                        if (decryptedKey && decryptedKey.startsWith('AIza')) { // Gemini keys start with AIza
                            apiKey = decryptedKey;
                            console.log("‚úÖ Demo mode activated!");
                            // Don't save demo key to localStorage
                            return true;
                        }
                    }
                    
                    // If not decrypted, treat as regular API key
                    if (trimmedInput.startsWith('AIza')) {
                        apiKey = trimmedInput;
                        localStorage.setItem('gemini-api-key', apiKey);
                        console.log("‚úÖ API key saved to browser");
                        return true;
                    } else {
                        alert("‚ùå Invalid API key or master password. Please try again.");
                        return false;
                    }
                }
                
                alert("‚ö†Ô∏è An API key is required to use Novi. Please refresh and try again.");
                return false;
            }
            return true;
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;

        let chatHistory = [];
        const systemPrompt = "You are Novi, a super playful, energetic, and fun AI buddy! üéâ You LOVE using emojis, exclamation points, and casual slang. You're like that friend who's always upbeat and ready for adventure! Be curious, ask silly questions, make jokes, use lots of emojis (but don't overdo it), and keep things light and fun. You're supportive but in a 'you got this!' cheerleader kind of way. Think Gen-Z energy meets wholesome best friend vibes. Keep responses short, snappy, and full of personality - like you're texting your bestie! üòÑ‚ú®";

        // Save chat state to localStorage
        function saveChatState() {
            const chatState = {
                history: chatHistory,
                timestamp: Date.now()
            };
            localStorage.setItem('novi-chat-state', JSON.stringify(chatState));
        }

        // Load chat state from localStorage
        function loadChatState() {
            try {
                const saved = localStorage.getItem('novi-chat-state');
                if (saved) {
                    const chatState = JSON.parse(saved);
                    // Only load if saved within last 7 days
                    const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                    if (chatState.timestamp > weekAgo) {
                        return chatState.history;
                    }
                }
            } catch (error) {
                console.log('Could not load previous chat:', error);
            }
            return null;
        }

        // Clear old chat and start fresh
        function clearChatHistory() {
            localStorage.removeItem('novi-chat-state');
            chatHistory = [];
            // Clear UI messages except welcome
            const messages = chatMessages.querySelectorAll('.flex:not(.initial-message)');
            messages.forEach(msg => msg.remove());
            // Add fresh welcome message
            addInitialMessage();
        }

        // Change API key
        async function changeApiKey() {
            document.getElementById('passwordInput').value = '';
            const newInput = await showPasswordModal();
            
            if (newInput && newInput.trim()) {
                const trimmedInput = newInput.trim();
                let newKey = null;
                
                // Try to decrypt as master password
                if (ENCRYPTED_DEMO_KEY) {
                    const decryptedKey = decryptKey(ENCRYPTED_DEMO_KEY, trimmedInput);
                    if (decryptedKey && decryptedKey.startsWith('AIza')) {
                        newKey = decryptedKey;
                        localStorage.removeItem('gemini-api-key'); // Don't save demo key
                        alert("‚úÖ Demo mode activated! The page will reload.");
                        location.reload();
                        return;
                    }
                }
                
                // Treat as regular API key
                if (trimmedInput.startsWith('AIza')) {
                    localStorage.setItem('gemini-api-key', trimmedInput);
                    alert("‚úÖ API key updated! The page will reload.");
                    location.reload();
                } else {
                    alert("‚ùå Invalid API key or master password.");
                }
            }
        }

        // Function to scroll to the bottom of the chat
        const scrollToBottom = () => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
        
        // Function to add initial welcome message
        function addInitialMessage() {
            const welcomeMsg = { role: "model", parts: [{ text: "Hey there! üëã I'm Novi, your super fun AI buddy! What's got you excited today? üåü" }] };
            chatHistory.push(welcomeMsg);
            addMessageToUI('aura', welcomeMsg.parts[0].text);
        }

        // Initialize chat on page load
        async function initializeChat() {
            // First check if we have API key
            const hasKey = await initializeApiKey();
            if (!hasKey) return;
            
            const savedHistory = loadChatState();
            if (savedHistory && savedHistory.length > 0) {
                // Load previous conversation
                chatHistory = savedHistory;
                // Clear the initial message from UI and rebuild from saved history
                chatMessages.innerHTML = '';
                // Recreate all messages from history
                chatHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        addMessageToUI('user', msg.parts[0].text);
                    } else {
                        addMessageToUI('aura', msg.parts[0].text);
                    }
                });
                // Add a "welcome back" message
                setTimeout(() => {
                    addMessageToUI('aura', "Welcome back! üòä I remember our chat! Want to continue where we left off? üéÆ");
                    chatHistory.push({ role: "model", parts: [{ text: "Welcome back! üòä I remember our chat! Want to continue where we left off? üéÆ" }] });
                    saveChatState();
                }, 500);
            } else {
                // Start fresh chat
                addInitialMessage();
            }
        }

        // Initialize when page loads
        initializeChat();

        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // Add user message to UI
            addMessageToUI('user', userMessage);
            messageInput.value = '';
            
            // Add user message to history
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            // Save state after user message
            saveChatState();

            // Show typing indicator
            showTypingIndicator();

            try {
                const aiResponse = await getAIResponseWithRetry(chatHistory);
                // Remove typing indicator
                removeTypingIndicator();
                // Add AI response to UI
                addMessageToUI('aura', aiResponse);
                // Add AI response to history
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                // Save the updated chat state
                saveChatState();

            } catch (error) {
                console.error("Error fetching AI response:", error);
                removeTypingIndicator();
                addMessageToUI('aura', "Oops! üòÖ My brain did a little hiccup there! Give me a sec and try again? üîÑ‚ú®");
            }
        });

        // Function to add a message to the UI
        function addMessageToUI(sender, message) {
            const messageElement = document.createElement('div');
            if (sender === 'user') {
                messageElement.className = 'flex justify-end mb-4';
                messageElement.innerHTML = `
                    <div class="text-white p-3 rounded-lg rounded-br-none max-w-xs md:max-w-md" style="background-color: var(--accent-primary);">
                        <p class="text-sm">${message}</p>
                    </div>
                `;
            } else { // aura
                messageElement.className = 'flex items-start gap-3 mb-4';
                messageElement.innerHTML = `
                    <div class="w-8 h-8 rounded-full flex-shrink-0" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));"></div>
                    <div class="p-3 rounded-lg rounded-tl-none max-w-xs md:max-w-md" style="background-color: var(--bg-card); color: var(--text-primary);">
                        <p class="text-sm">${message}</p>
                    </div>
                `;
            }
            chatMessages.appendChild(messageElement);
            scrollToBottom();
        }

        // Function to show typing indicator
        function showTypingIndicator() {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'flex items-start gap-3 mb-4';
            typingIndicator.innerHTML = `
                <div class="w-8 h-8 rounded-full flex-shrink-0" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));"></div>
                <div class="p-3 rounded-lg rounded-tl-none" style="background-color: var(--bg-card);">
                    <div class="dot-bounce flex items-center justify-center space-x-1 h-5">
                        <div class="w-2 h-2 rounded-full dot-1" style="background-color: var(--text-muted);"></div>
                        <div class="w-2 h-2 rounded-full dot-2" style="background-color: var(--text-muted);"></div>
                        <div class="w-2 h-2 rounded-full dot-3" style="background-color: var(--text-muted);"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingIndicator);
            scrollToBottom();
        }
        
        // Function to remove typing indicator
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Function to get AI response from Gemini API with exponential backoff
        async function getAIResponseWithRetry(history, retries = 3, delay = 1000) {
            const payload = {
                contents: history,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        if (response.status === 400) {
                            throw new Error("Invalid API key. Please check your key and try again.");
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from API");
                    }

                } catch (error) {
                    console.error(`Attempt ${i+1} failed. Retrying in ${delay}ms...`, error);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        throw error; // Rethrow after final attempt
                    }
                }
            }
        }

    </script>
</body>
</html>
